import { Meta, Story, Canvas } from '@storybook/addon-docs';

import * as Fiber from '../../core/lumby.fiber';

<Meta title="Core/Fiber" component={Fiber} />

## Lumby Fiber

Because Lumby is built with `zustand` and `emotionjs`, `Fiber` serves as a layer managing
information exchange between global state and css-in-js.

Lumby fiber consist of two classes: `LumbyCanvas` and `LumbyFiber` and two functions: `lumbyFiber` and `FiberLayer`.

#### - `LumbyCanvas`

`LumbyCanvas` holds basic config used by Lumby's components. Each property of this class affects final
styling of the component. `LumbyCanvas`'s properties are translated by [lumbyFiber](#--lumbyFiber) function.

```typescript
import { lumbyTheme } from './lumby.theme';

export class LumbyCanvas {
  show = true;
  flat = false;
  block = false;
  error = false;
  elevate = false;
  working = false;
  disabled = false;
  theme = lumbyTheme();
  size: ThemeSize = 'md';
  content: GridContent = [-1, 0];
  variant: ThemeVariant = 'default';
  margins: ThemeSize | 'size' = 'size';
  paddings: ThemeSize | 'size' = 'size';
  full: 'page' | 'screen' | 'none' = 'none';
  corners: ThemeSize | 'disk' | 'size' = 'size';
}
```

#### - `LumbyFiber`

`LumbyFiber` is a small class that extends `LumbyCanvas` with `fid` property that is used by Lumby internally. `fid` (short for fiber id) is a key
used by `zustand` to target pieces of global store and allow changing component's css-in-js styling from different parts of the UI.
`fid` is not required and if it is not supplied to the component it just works as you'd expect of any component. However, if you provide a `fid`
to any Lumby component, it'll become a part of the Lumby's layer, reactive to the changes of `LumbyCanvas`'s props assigned to that `fid`.

```typescript
export class LumbyFiber extends LumbyCanvas {
  fid?: string = undefined;
}
```

#### - `lumbyFiber`

This function takes one required and one optional argument. It uses [deepmerge](https://www.npmjs.com/package/deepmerge) to merge `LumbyFiber`s
and then it uses the merged result to build styles for a component using a util [canvasStylesheet]() function.

```typescript
import deepmerge from 'deepmerge';
import { canvasStylesheet } from './lumby.utils';

export function lumbyFiber(
  newFiber: Partial<LumbyFiber>,
  oldFiber: Partial<LumbyFiber> = new LumbyFiber()
) {
  const fiber = deepmerge(oldFiber, newFiber);
  return { fiber, canvas: () => canvasStylesheet(fiber) };
}
```

#### - `FiberLayer`

`FiberLayer` is a `<div>` created using `styled` function from `@emotion/styled`. It is using [useLumbyFiber]() hook that allows Lumby to reactively
apply styles to any Lumby component's canvas, regardless of whether it's hooked with `fid` prop or not.

```typescript
import styled from '@emotion/styled';

export const FiberLayer = styled('div', {
  label: 'fiber-canvas',
})<Partial<FiberCanvasProps>>((props) => {
  const fiber = useLumbyFiber(props.fid, props);

  const styles = {};
  const canvas = fiber.canvas();

  // loop styling attributes and apply canvas styling to existing ones
  (Object.keys(canvas) as (keyof StylesheetResult)[]).forEach((attr) => {
    if (canvas[attr]) styles[attr] = canvas[attr]();
  });

  return css({
    ...styles,

    '&:hover': {
      color: canvas.color('hover'),
      boxShadow: canvas.boxShadow(1),
      borderColor: canvas.borderColor('hover'),
      backgroundColor: canvas.backgroundColor('hover'),
    },

    '&:focus': {
      color: canvas.color('focus'),
      boxShadow: canvas.boxShadow(1),
      borderColor: canvas.borderColor('focus'),
      backgroundColor: canvas.backgroundColor('focus'),
    },

    '&:active': {
      color: canvas.color('active'),
      borderColor: canvas.borderColor('active'),
      backgroundColor: canvas.backgroundColor('active'),
    },
  });
});
```
